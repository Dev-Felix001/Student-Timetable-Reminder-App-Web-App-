<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Timetable Reminder</title>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <main class="app">
    <header class="header">
      <div class="header-content">
        <h1 class="app-title">Timetable Reminder</h1>
        <p class="tagline">Add classes and get browser notifications before they start</p>
      </div>
      <div class="header-actions">
        <button id="requestPerm" class="btn primary small">Enable Notifications</button>
      </div>
    </header>

    <div class="content-grid">
      <section class="card form-card" aria-labelledby="add-class-heading">
        <div class="card-header">
          <h2 id="add-class-heading">Add New Class</h2>
          <div class="card-actions">
            <button id="clearAll" class="btn ghost small">Clear All</button>
          </div>
        </div>

        <form id="classForm" class="form">
          <div class="form-group">
            <label for="title" class="form-label">
              <span class="label-text">Class Name</span>
              <input type="text" id="title" required placeholder="e.g. Algorithms & Data Structures" />
            </label>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="date" class="form-label">
                <span class="label-text">Date</span>
                <input type="date" id="date" required />
              </label>
            </div>
            
            <div class="form-group">
              <label for="time" class="form-label">
                <span class="label-text">Start Time</span>
                <input type="time" id="time" required />
              </label>
            </div>
          </div>

          <div class="form-group">
            <label for="reminder" class="form-label">
              <span class="label-text">Reminder (minutes before)</span>
              <input type="number" id="reminder" min="0" max="1440" value="15" required />
              <span class="input-hint">Set how many minutes before class to receive notification</span>
            </label>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn primary large">
              <span class="btn-icon">+</span>
              Add to Schedule
            </button>
          </div>
        </form>

        <div class="card-footer">
          <p class="note">Works best on modern browsers. Allow notifications when prompted.</p>
        </div>
      </section>

      <section class="card list-card" aria-labelledby="upcoming-heading">
        <div class="card-header">
          <h2 id="upcoming-heading">Upcoming Classes</h2>
          <div class="card-badge" id="classCount">0</div>
        </div>

        <div class="card-content">
          <ul id="items" class="items" aria-live="polite"></ul>
          <div id="empty" class="empty-state">
            <div class="empty-icon">ðŸ“š</div>
            <h3>No classes scheduled</h3>
            <p>Add your first class using the form on the left</p>
          </div>
        </div>
      </section>
    </div>

    <footer class="footer">
      <div class="footer-content">
        <div class="footer-info">
          <small>All data is stored locally on your device</small>
        </div>
        <div class="footer-status">
          <span class="status-indicator" id="statusIndicator"></span>
          <span id="statusText">Ready</span>
        </div>
      </div>
    </footer>
  </main>

  <script>
    // Enhanced Timetable Reminder Application
    (function(){
      const form = document.getElementById('classForm');
      const titleEl = document.getElementById('title');
      const dateEl = document.getElementById('date');
      const timeEl = document.getElementById('time');
      const reminderEl = document.getElementById('reminder');
      const itemsEl = document.getElementById('items');
      const emptyEl = document.getElementById('empty');
      const clearAllBtn = document.getElementById('clearAll');
      const requestBtn = document.getElementById('requestPerm');
      const classCountEl = document.getElementById('classCount');
      const statusIndicator = document.getElementById('statusIndicator');
      const statusText = document.getElementById('statusText');

      const STORAGE_KEY = 'timetable-items-v2';
      let items = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      let notificationPermission = Notification.permission;

      // Update UI based on notification permission
      function updateNotificationStatus() {
        notificationPermission = Notification.permission;
        if (notificationPermission === 'granted') {
          statusIndicator.className = 'status-indicator active';
          statusText.textContent = 'Notifications enabled';
          requestBtn.style.display = 'none';
        } else if (notificationPermission === 'denied') {
          statusIndicator.className = 'status-indicator denied';
          statusText.textContent = 'Notifications blocked';
          requestBtn.style.display = 'inline-flex';
        } else {
          statusIndicator.className = 'status-indicator';
          statusText.textContent = 'Notifications not set up';
          requestBtn.style.display = 'inline-flex';
        }
      }

      function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
        updateClassCount();
      }

      function updateClassCount() {
        const count = items.length;
        classCountEl.textContent = count;
        
        // Update empty state visibility
        if (count === 0) {
          emptyEl.style.display = 'flex';
        } else {
          emptyEl.style.display = 'none';
        }
      }

      function formatDateTime(d) {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const isToday = d.toDateString() === today.toDateString();
        const isTomorrow = d.toDateString() === tomorrow.toDateString();
        
        let dateStr;
        if (isToday) {
          dateStr = 'Today';
        } else if (isTomorrow) {
          dateStr = 'Tomorrow';
        } else {
          dateStr = d.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
        }
        
        const timeStr = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        return `${dateStr} at ${timeStr}`;
      }

      function render() {
        itemsEl.innerHTML = '';
        if (!items.length) {
          updateClassCount();
          return;
        }
        
        // Sort by date/time
        items.sort((a,b) => new Date(a.when) - new Date(b.when));
        
        items.forEach((it, idx) => {
          const li = document.createElement('li');
          li.className = 'item';
          
          const when = new Date(it.when);
          const now = new Date();
          const timeDiff = when.getTime() - now.getTime();
          const hoursDiff = timeDiff / (1000 * 60 * 60);
          
          // Add urgency class if class is within 24 hours
          if (hoursDiff < 24 && hoursDiff > 0) {
            li.classList.add('urgent');
          }
          
          // Add passed class if class has already occurred
          if (timeDiff < 0) {
            li.classList.add('passed');
          }
          
          const content = document.createElement('div');
          content.className = 'item-content';
          
          const title = document.createElement('div');
          title.className = 'item-title';
          title.textContent = it.title;
          
          const meta = document.createElement('div');
          meta.className = 'item-meta';
          meta.textContent = formatDateTime(when);
          
          const reminder = document.createElement('div');
          reminder.className = 'item-reminder';
          reminder.textContent = `Reminder: ${it.reminder} min before`;
          
          content.appendChild(title);
          content.appendChild(meta);
          content.appendChild(reminder);
          
          const actions = document.createElement('div');
          actions.className = 'item-actions';
          
          const del = document.createElement('button');
          del.className = 'btn icon-btn delete-btn';
          del.setAttribute('aria-label', 'Delete class');
          del.innerHTML = 'Ã—';
          del.addEventListener('click', () => {
            items.splice(idx, 1);
            save();
            render();
            scheduleAll();
          });
          
          actions.appendChild(del);
          
          li.appendChild(content);
          li.appendChild(actions);
          itemsEl.appendChild(li);
        });
        
        updateClassCount();
      }

      function scheduleAll() {
        // Clear existing timeouts (in a real app, we'd track them)
        const now = Date.now();
        items.forEach(it => {
          const when = new Date(it.when).getTime();
          const remindAt = when - (Number(it.reminder) || 0) * 60000;
          const delay = remindAt - now;
          
          if (delay > 0 && delay < 2147483647) { // Max setTimeout value
            setTimeout(() => triggerNotification(it), delay);
          }
        });
      }

      function triggerNotification(item) {
        const text = `${item.title} starts at ${new Date(item.when).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
        
        if (window.Notification && Notification.permission === 'granted') {
          try {
            const notification = new Notification('Class Reminder', { 
              body: text,
              icon: '/icon.png', // You would add an actual icon
              tag: 'class-reminder'
            });
            
            notification.onclick = function() {
              window.focus();
              this.close();
            };
          } catch(e) {
            // Fallback to alert if Notification constructor fails
            alert(`Reminder: ${item.title}\n${text}`);
          }
        } else {
          // Fallback to alert
          alert(`Reminder: ${item.title}\n${text}`);
        }
      }

      form.addEventListener('submit', (ev) => {
        ev.preventDefault();
        const title = titleEl.value.trim();
        const date = dateEl.value;
        const time = timeEl.value;
        const reminder = Math.max(0, Math.min(1440, Number(reminderEl.value || 15)));
        
        if (!title || !date || !time) {
          showStatus('Please fill in all fields', 'error');
          return;
        }
        
        const when = new Date(date + 'T' + time);
        if (isNaN(when)) {
          showStatus('Invalid date or time', 'error');
          return;
        }
        
        // Check if this is a duplicate
        const duplicate = items.find(item => 
          item.title === title && 
          new Date(item.when).getTime() === when.getTime()
        );
        
        if (duplicate) {
          showStatus('This class is already scheduled', 'warning');
          return;
        }
        
        items.push({ title, when: when.toISOString(), reminder });
        save();
        render();
        scheduleAll();
        form.reset();
        
        // Set default date to today and time to next hour
        setDefaultDateTime();
        reminderEl.value = 15;
        
        showStatus('Class added successfully!', 'success');
      });

      clearAllBtn.addEventListener('click', () => {
        if (items.length === 0) {
          showStatus('No classes to clear', 'info');
          return;
        }
        
        if (confirm('Are you sure you want to clear all classes?')) {
          items = [];
          save();
          render();
          showStatus('All classes cleared', 'info');
        }
      });

      requestBtn.addEventListener('click', async () => {
        if (!('Notification' in window)) {
          showStatus('Notifications not supported in this browser', 'error');
          return;
        }
        
        const permission = await Notification.requestPermission();
        updateNotificationStatus();
        
        if (permission === 'granted') {
          showStatus('Notifications enabled!', 'success');
        } else {
          showStatus('Notifications blocked. You can enable them in browser settings.', 'warning');
        }
      });

      function setDefaultDateTime() {
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        dateEl.value = `${yyyy}-${mm}-${dd}`;
        
        // Set time to next hour
        const nextHour = now.getHours() + 1;
        timeEl.value = `${String(nextHour).padStart(2, '0')}:00`;
      }

      function showStatus(message, type = 'info') {
        statusText.textContent = message;
        statusIndicator.className = `status-indicator ${type}`;
        
        // Reset after 3 seconds
        setTimeout(() => {
          updateNotificationStatus();
        }, 3000);
      }

      // Initialize
      setDefaultDateTime();
      updateNotificationStatus();
      render();
      scheduleAll();

      // Listen for storage changes (from other tabs)
      window.addEventListener('storage', (e) => {
        if (e.key === STORAGE_KEY) {
          items = JSON.parse(e.newValue || '[]');
          render();
          scheduleAll();
        }
      });

      // Update notification status when page becomes visible
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          updateNotificationStatus();
        }
      });

    })();
  </script>
</body>
</html>